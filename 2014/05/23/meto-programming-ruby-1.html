<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Ruby 元编程 - Part I [草稿]</title>
    <meta name="viewport" content="width=device-width">

    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">

    <!-- tags css -->
    <link rel="stylesheet" href="/css/tag_cloud.css">

</head>
<body>

<div class="site">
    <div class="header">
        <h1 class="title"><a href="/">Blog Everything</a></h1>
        <a class="extra" href="/">主页</a>
    </div>

    <h2>Ruby 元编程 - Part I [草稿]</h2>
<p class="meta">23 May 2014</p>

<div class="post">
    <blockquote>
<p>meta programming ruby is write code that write code that write code ...!</p>
</blockquote>

<p><em>objects</em> 在 Ruby 程序中随处可见，在 Ruby 的语言构件( <em>language constructs</em> )中, <em>objects</em> 只是其中一种，
还有 <em>classes</em>, <em>modules</em>, <em>instance variables</em> 等等．Ruby 的元编程过程本质上是对这些语言构件的操作．</p>

<p>Ruby 的语言构件都依附于另一个东西，在 Ruby 中它叫做 <em>object model</em>．深入了解了这个核心概念后，Ruby 的一些高级
功能会看起来很自然．</p>

<h3>Open Classes</h3>

<p>在 Ruby 中，<code>class</code> 关键字不只是用来定义一个类，还可以修改一个类的定义，这种用法叫 <em>Open Classes</em>．例如：</p>

<div class="highlight"><pre><code class="ruby"><span class="k">def</span> <span class="nf">to_alphanumeric</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">gsub</span> <span class="sr">/[^\w\s]/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
<span class="k">end</span>

<span class="nb">require</span> <span class="s1">&#39;test/unit&#39;</span>
<span class="k">class</span> <span class="nc">ToAlphanumericTest</span> <span class="o">&lt;</span> <span class="no">Test</span><span class="o">::</span><span class="no">Unit</span><span class="o">::</span><span class="no">TestCase</span>
    <span class="k">def</span> <span class="nf">test_strips_non_alphanumeric_characters</span>
        <span class="n">assert_equal</span> <span class="s1">&#39;3 the Magic Number&#39;</span> <span class="p">,</span> <span class="n">to_alphanumeric</span><span class="p">(</span><span class="s1">&#39;#3, the *Magic, Number*?&#39;</span> <span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>这个用法不符合 <code>OO</code> 的风格，可以改为：</p>

<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">String</span>
    <span class="k">def</span> <span class="nf">to_alphanumeric</span>
        <span class="nb">gsub</span> <span class="sr">/[^\w\s]/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="nb">require</span> <span class="s1">&#39;test/unit&#39;</span>
<span class="k">class</span> <span class="nc">ToAlphanumericTest</span> <span class="o">&lt;</span> <span class="no">Test</span><span class="o">::</span><span class="no">Unit</span><span class="o">::</span><span class="no">TestCase</span>
    <span class="k">def</span> <span class="nf">test_strips_non_alphanumeric_characters</span>
        <span class="n">assert_equal</span> <span class="s1">&#39;3 the Magic Number&#39;</span> <span class="p">,</span> <span class="s1">&#39;#3, the *Magic, Number*?&#39;</span><span class="o">.</span><span class="n">to_alphanumeric</span>
    <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>通过关键字 <code>class</code> 重新打开了 <code>String</code> 的定义，加入了一个方法 <code>to_alphanumeric</code>，然后所有 <code>String</code> 的
实例都能使用这个方法．</p>

<p>使用 <em>Open Classes</em> 意味着可以随时修改一个类，包括系统提供的类，但这样做会引发问题：</p>

<ol>
<li>对修改的类造成污染</li>
<li>可能会覆盖已经存在的方法，形成 <em>monkey patch</em></li>
</ol>

<p>使用 <em>Open Classes</em> 之前，先考虑：</p>

<ol>
<li>是否加入的方法足够通用</li>
<li>有没有和已经存在的方法造成冲突</li>
</ol>

<h3>Objects, Instance Variables and Methods</h3>

<p>定义 <code>MyClass</code>并生成实例：</p>

<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">MyClass</span>
    <span class="k">def</span> <span class="nf">my_method</span>
        <span class="vi">@v</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">obj</span> <span class="o">=</span> <span class="no">MyClass</span><span class="o">.</span><span class="n">new</span>
<span class="n">obj</span><span class="o">.</span><span class="n">class</span><span class="err">　　</span><span class="c1"># =&gt; MyClass</span>

<span class="n">obj</span><span class="o">.</span><span class="n">my_method</span>
<span class="n">obj</span><span class="o">.</span><span class="n">instance_variables</span><span class="err">　　</span><span class="c1"># =&gt; [:@v]</span></code></pre></div>

<p><center><img src="/images/meta-ruby/object-01.jpg" alt="object, instance variables, method"></center></p>

<p>重点：</p>

<ol>
<li><em>instance variables</em> 在 <em>objects</em> 中， <em>methods</em> 在 <em>classes</em> 中</li>
<li>不同于 <code>Java</code>, <em>class</em> 与 <em>instance variables</em> 是没有联系的， <em>instance variables</em> 在 <em>objects</em>
中就像 <code>Hash</code> 的键值对，所以 <em>classes</em> 的实例可以有不一样的 <em>instane variables</em>．</li>
</ol>

<p>理解下面两句话：</p>

<div class="highlight"><pre><code class="ruby"><span class="nb">String</span><span class="o">.</span><span class="n">instance_methods</span> <span class="o">==</span> <span class="s2">&quot;abc&quot;</span><span class="o">.</span><span class="n">methods</span>    <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="nb">String</span><span class="o">.</span><span class="n">methods</span> <span class="o">==</span> <span class="s2">&quot;abc&quot;</span><span class="o">.</span><span class="n">methods</span>             <span class="o">=&gt;</span> <span class="kp">false</span></code></pre></div>

<p>关键在于 <code>String</code> 也是一个 <em>object</em>！</p>


    
    <h3>标签 : </h3>
    <p class="tags">
        
        <a href="/tags/Ruby/">Ruby</a>
        
    </p>
    

    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'lyfblog'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>


    <div class="footer">
        <div class="contact">
            <p>
                YifengLiu<br/>
                software engineer<br/>
            </p>
        </div>
        <div class="contact">
            <p>
                <a href="https://github.com/lyfshadyboss">github.com/lyfshadyboss</a><br/>
                <a href="https://twitter.com/lyfshadyboss">twitter.com/lyfshadyboss</a><br/>
            </p>
        </div>
    </div>
</div>

</body>
</html>
